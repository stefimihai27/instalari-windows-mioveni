<script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
<script>
    // 1. INIȚIALIZARE CMS
    CMS.init({
      config: {
        backend: {
          name: "github",
          repo: "stefimihai27/instalari-windows-mioveni",
          branch: "main",
          auth_type: "token"
        },
        load_config_file: false,
        display_url: "https://instalari-windows-mioveni.vercel.app",
        collections: [
          {
            name: "setari",
            label: "Setări Site",
            files: [
              {
                name: "home",
                label: "Pagina Principală",
                file: "index.html",
                fields: [
                  { label: "Titlu Hero", name: "hero_title", widget: "string" },
                  { label: "Telefon", name: "phone", widget: "string" },
                  { label: "Pret Basic", name: "price_basic", widget: "string" },
                  { label: "Pret Complet", name: "price_complet", widget: "string" }
                ]
              }
            ]
          }
        ]
      }
    });

    // 2. LOGICA DE NETLIFY IDENTITY
    if (window.netlifyIdentity) {
        netlifyIdentity.on('init', user => {
            if (!user) {
                window.location.href = '/';
            } else {
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('admin-content').classList.remove('hidden');
                document.getElementById('logout-btn').classList.remove('hidden');
                // Sincronizăm datele din GitHub cu câmpurile tale la încărcare
                setTimeout(loadAdminDataFromCMS, 2000); 
            }
        });
    }

    // 3. FUNCȚII DE SALVARE CORECtate
    // Această funcție face legătura între input-ul tău și motorul de salvare GitHub
    function syncAndSave(fieldName, value) {
        // Notificăm CMS-ul că am schimbat o valoare
        window.CMS.getEditor().setFieldValue(fieldName, value);
        alert(`Valoarea pentru ${fieldName} a fost pregătită. Apasă butonul "Publish" din bara Decap pentru a finaliza salvarea pe site.`);
    }

    function savePrice(type) {
        const value = document.getElementById(`price-${type}`).value;
        const fieldMap = type === 'basic' ? 'price_basic' : 'price_complet';
        syncAndSave(fieldMap, value);
    }

    function savePhone() {
        const phone = document.getElementById('admin-phone').value;
        syncAndSave('phone', phone);
    }

    // Această funcție ia prețurile reale din fișierul index.html și le pune în input-urile tale
    function loadAdminDataFromCMS() {
        try {
            const entry = window.CMS.getEntry('setari', 'home');
            if (entry) {
                const data = entry.get('data').toJS();
                if(data.price_basic) document.getElementById('price-basic').value = data.price_basic;
                if(data.price_complet) document.getElementById('price-complet').value = data.price_complet;
                if(data.phone) document.getElementById('admin-phone').value = data.phone;
            }
        } catch (e) {
            console.log("Se încarcă motorul CMS...");
        }
    }
</script>
